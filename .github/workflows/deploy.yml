name: Deploy

on:
    push:
      branches: [main]
env:
    Test: ${{vars.TEST}}

jobs:
    env:
        name:  Discover env to deploy to
        runs-on: ubuntu-latest
   
        steps:
          - name: Some check on branch
            id: branch_check
            run: |
              echo "Running on branch ${{ github.ref }}"
              if [ "${{ github.ref }}" = "refs/heads/main" ]; then
              echo "env_name=prod" >> $GITHUB_OUTPUT
              elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
              echo "env_name=dev" >> $GITHUB_OUTPUT
              else
                  echo "env_name=dev" >> $GITHUB_OUTPUT
              fi
            
          - name: Use variable setup in previous step
            run: echo "I'm using variable ${{ steps.branch_check.outputs.env_name }}"
        outputs:
            env_name: ${{ steps.branch_check.outputs.env_name }}     

    build-and-test:
        name: Deploy to ${{ needs.env.outputs.env_name }}
        runs-on: ubuntu-latest
        needs: [env]
        environment: 
            name: ${{ needs.env.outputs.env_name }}

        steps:
        - uses: actions/checkout@v3
        - run: env
        - run: echo ${{vars.TEST}}
        - run: echo ${{env.Test}}
        - run: echo ${{secrets.notsoSecure}}

    test:
        runs-on: ubuntu-latest
        strategy:
          matrix:
            value: ["1", "2", "2"]
        steps:
          - uses: 'actions/checkout@v3'
            with:
              fetch-depth: 2
          - name: check ${{ matrix.value }} folder
            id: check_${{ matrix.value }}
            run: |
                echo "${{ matrix.value }}"
